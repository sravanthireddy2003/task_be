CREATE TABLE `users` (
  `_id` INT(11) NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  `title` VARCHAR(255) NOT NULL,
  `role` VARCHAR(255) NOT NULL,
  `email` VARCHAR(255) NOT NULL,
  `password` VARCHAR(255) NOT NULL,
  `isAdmin` TINYINT(1) DEFAULT 0,
  `tasks` TEXT DEFAULT '[]',
  `createdAt` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updatedAt` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `__v` INT(11) DEFAULT 0,
  `isActive` TINYINT(1) DEFAULT 1,
  PRIMARY KEY (`_id`)
);


-- taskassignments
CREATE TABLE taskassignmentsss (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_Id INT NOT NULL,
    task_Id INT NOT NULL,
    FOREIGN KEY (user_Id) REFERENCES users(_id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (task_Id) REFERENCES tasks(id) ON DELETE CASCADE ON UPDATE CASCADE
);

ALTER TABLE Student RENAME TO Student_Details;

-- tasks
CREATE TABLE tasks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    stage VARCHAR(50),
    taskDate DATE,
    priority VARCHAR(255) NOT NULL,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
ALTER TABLE tasks ADD COLUMN assets VARCHAR(255);


-- subtasks
CREATE TABLE subtasks (
    id INT AUTO_INCREMENT PRIMARY KEY,
    task_Id INT NOT NULL,
    tag VARCHAR(255),
    title VARCHAR(255) NOT NULL,
    due_date TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_Id) REFERENCES tasks(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- subtaskassign
CREATE TABLE subtaskassign (
    id INT AUTO_INCREMENT PRIMARY KEY,
    subtask_Id INT NOT NULL,
    task_Id INT NOT NULL,
    FOREIGN KEY (subtask_Id) REFERENCES subtaskss(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (task_Id) REFERENCES tasks(id) ON DELETE CASCADE ON UPDATE CASCADE
);


-- WH
CREATE TABLE WorkingHours (
  id INT AUTO_INCREMENT PRIMARY KEY,
  task_id INT NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  working_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);

-- to get report
SELECT 
  t.title AS task_title, 
  w.working_date, 
  w.start_time, 
  w.end_time, 
  TIMESTAMPDIFF(HOUR, w.start_time, w.end_time) AS duration_hours
FROM 
  WorkingHours w
JOIN 
  tasks t ON w.task_id = t.id
WHERE 
  t.title = 'sdbakjbds'
  AND w.working_date BETWEEN '2024-08-01' AND '2024-08-28'
ORDER BY 
  w.working_date;
